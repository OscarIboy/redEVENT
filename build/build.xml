<?xml version="1.0" encoding="UTF-8"?>
<project name="redEVENT" description="redEVENT for Joomla!" default="all" >
	<property file="./build.properties" />
	
	<!-- Default properties, set only if not already assigned in the build.properties file -->
	<property name="dirs.root" value=".." />
	<property name="dirs.component" value="../component" />
	<property name="dirs.languages" value="../languages" />
	<property name="dirs.modules" value="../modules" />
	<property name="dirs.release" value="../release" />
	<property name="dirs.plugins" value="../plugins" />
	<property name="dirs.3pd" value="../3pd" />
	<property name="dirs.tmp" value="../tmp" />
	<property name="version" value="dev" />

	<property name="dirs.bin" value="bin" />
	<property name="dirs.bin.libxml" value="${dirs.bin}/libxml" />
	<property name="dirs.bin.fop" value="${dirs.bin}/fop" />
	<property name="dirs.bin.dbxsl" value="${dirs.bin}/dbxsl" />
	<property name="dirs.bin.release" value="../release" />

	<taskdef name="gitversion" classname="phingext.GitVersionTask" />
	<taskdef name="gitdate" classname="phingext.GitDateTask" />
		
	<!--
	====================================================================================================
	Tasks - General
	====================================================================================================
	-->
	
	<target name="all" description="Makes everything"
		depends="dev-release">
	</target>
	
	<target name="dev-release" description="Makes the release"
		depends="new-release,setup-properties,release">
	</target>

	<target name="new-release" description="Create the release directory afresh">
		<!-- Recreate the release directory -->
		<delete dir="${dirs.release}" quiet="yes" includeemptydirs="false" />
		<mkdir dir="${dirs.release}" />
	</target>
	
	<target name="setup-properties" description="Set up version and build properties">
		<!-- Initialize the build.date timestamp -->
		<tstamp>
			<format property="build.date" pattern="%Y-%m-%d" />
		</tstamp>

		<!-- Initialize the version if it's not set -->
		<if>
			<equals arg1="${version}" arg2="dev" />
			<then>
				<gitversion workingcopy="${dirs.root}" propertyname="git.lastrevision" />
				<gitdate workingcopy="${dirs.root}" propertyname="git.timestamp" />
				<!--<property name="version" value="rev${git.lastrevision}" override="true" />-->
				<property name="version" value="${git.lastrevision}-${git.timestamp}" override="true" />
			</then>
		</if>
	</target>
	
	<!--
	====================================================================================================
	Tasks - Joomla! packages
	====================================================================================================
	-->
	
	<target name="release" description="redEVENT Installation Package for Joomla! 1.6+"
		depends="new-release,setup-properties">

		<copy todir="${dirs.tmp}/component" >
			<fileset dir="${dirs.component}">
				<include name="**" />
			</fileset>
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<!-- Create the package -->
		<tar basedir="${dirs.tmp}/component" destfile="${dirs.release}/com_redevent-${version}.tar.gz" includeemptydirs="true" compression="gzip" />
		
		<!-- modules -->
		<foreach param="dirname" absparam="absname" target="zipfolder">
		  <fileset dir="${dirs.modules}">
		  	<type type="dir"/>
	        <depth max="0" min="0" />
		  </fileset>
		</foreach>
		
		<!-- languages -->
		<foreach param="dirname" absparam="absname" target="zipfolder">
		  <fileset dir="${dirs.languages}">
		  	<type type="dir"/>
	        <depth max="0" min="0" />
		  </fileset>
		</foreach>
		
		<!-- josetta -->
		<foreach param="dirname" absparam="absname" target="zipfolder">
		  <fileset dir="${dirs.3pd}/josetta">
		  	<type type="dir"/>
	        <depth max="0" min="0" />
		  </fileset>
		</foreach>
		
		<delete dir="${dirs.tmp}" quiet="yes" includeemptydirs="false" />
	</target>
	
	<target name="zipfolder">
	    <echo msg="packaging ${dirname} ${absname}" />
		<copy todir="${dirs.tmp}/${dirname}" >
			<fileset dir="${absname}">
				<include name="**" />
			</fileset>
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		<!-- Create the package -->
		<tar basedir="${dirs.tmp}/${dirname}" destfile="${dirs.release}/${dirname}-${version}.tar.gz" includeemptydirs="true" compression="gzip" />
	</target>
</project>